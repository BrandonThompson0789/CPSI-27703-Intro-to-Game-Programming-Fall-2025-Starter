name: Nightly Build

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.display }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            display: linux
            artifact_path: dist/linux-x64/demo-linux-x64-release.zip
            artifact_name: demo-linux-x64-release.zip
          - os: windows-latest
            display: windows
            artifact_path: dist\windows-x64\demo-windows-x64-release.zip
            artifact_name: demo-windows-x64-release.zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure vcpkg binary cache (Linux/macOS)
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" >> $GITHUB_ENV
        shell: bash

      - name: Configure vcpkg binary cache (Windows)
        if: runner.os == 'Windows'
        run: Add-Content $env:GITHUB_ENV "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite"
        shell: pwsh

      - name: Cache vcpkg downloads
        uses: actions/cache@v4
        with:
          path: external/vcpkg/downloads
          key: vcpkg-downloads-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-downloads-${{ runner.os }}

      - name: Enable Git long paths
        if: runner.os == 'Windows'
        run: git config --global core.longpaths true
        shell: pwsh

      - name: Map short workspace path
        if: runner.os == 'Windows'
        run: |
          subst W: $env:GITHUB_WORKSPACE
          Add-Content $env:GITHUB_ENV "SHORT_WORKSPACE=W:\"
        shell: pwsh

      - name: Install Linux build prerequisites
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build zip autoconf automake libtool libltdl-dev pkg-config build-essential

      - name: Install Windows build prerequisites
        if: runner.os == 'Windows'
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          choco install ninja -y
        shell: pwsh

      - name: Bootstrap vcpkg (Linux)
        if: runner.os == 'Linux'
        run: ./external/vcpkg/bootstrap-vcpkg.sh
        shell: bash

      - name: Bootstrap vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          Set-Location $env:SHORT_WORKSPACE
          .\external\vcpkg\bootstrap-vcpkg.bat
        shell: pwsh

      - name: Build release package (Linux)
        if: runner.os == 'Linux'
        run: |
          bash ./build_release.sh

      - name: Build release package (Windows)
        if: runner.os == 'Windows'
        run: |
          Set-Location $env:SHORT_WORKSPACE
          .\build_release.bat
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}

      - name: Remove short workspace mapping
        if: runner.os == 'Windows'
        run: |
          subst W: /D
        shell: pwsh

  release:
    name: Publish Unstable Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Generate release notes
        run: |
          echo "Unstable build for $GITHUB_SHA" > release-notes.md
          echo >> release-notes.md
          echo "Triggered by push to $GITHUB_REF." >> release-notes.md

      - name: Create/update pre-release
        uses: ncipollo/release-action@v1
        with:
          tag: unstable
          name: Unstable build
          bodyFile: release-notes.md
          prerelease: true
          allowUpdates: true
          removeArtifacts: true
          makeLatest: false
          artifacts: "dist/**/*.zip"

